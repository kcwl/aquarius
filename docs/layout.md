本文说明elastic语言的内存布局模型，相关类型介绍参考[设计文档]


# 消息结构
在实际编码中，有3种编码类型，分别为：varint(变体)，length-body(带有长度前缀的结构)和fix-type(固定长度的类型)

|名字|用途|
|----|----|
|varint|int32,int64,uint32,uint64,bool,enum|
|length-body|string,bytes,repeated|
|fix-type|fixed32,fixed64,float,double|


## varint(变长整形)
varint 中的每个字节都有一个连续位，指示其后面的字节是否是 varint 的一部分。这是字节的最高有效位(MSB)（有时也称为符号位）。低7位是有效负载；结果整数是通过将其组成字节的 7 位有效负载附加在一起而构建的。

例如，这里是数字 1，编码为`01`– 它是单个字节，因此未设置 MSB：
```
0000 0001
^ msb
```
这里是150，编码为`9601`:
```
10010110 00000001
^ msb    ^ msb
```

首先，删除每个字节中的 MSB，因为这只是告诉我们是否已到达数字的末尾。每个字节余下的7位有效负载采用小端顺序，转换为大端顺序连接并解释为64位无符号整数：
```
10010110 00000001        // Original inputs.
 0010110  0000001        // Drop continuation bits.
 0000001  0010110        // Convert to big-endian.
   00000010010110        // Concatenate.
 128 + 16 + 4 + 2 = 150  // Interpret as an unsigned 64-bit integer.
```
因为变体对于协议缓冲区非常重要，所以在原型语法中，我们将它们称为普通整数。。
varinit属于本语言的基本数据类型，我们将它称为普通整数，等同于内置整数类型,即：`150等同于9601`。


## 布尔值和枚举
bool 和 enum 都被编码为int32。特别是布尔值，总是编码为`00`或`01`。

## 有符合整数
正如您在上一节中看到的，整形类型都被编码为 varint。但是，变长整型是无符号的，因此不同的有符号类型对负整数进行不同的编码。

这些intN类型将负数编码为二进制补码，这意味着，作为无符号 64 位整数，它们具有最高位集。因此，这意味着必须使用所有十个字节。例如，-2通过原码转换为
```
11111110 11111111 11111111 11111111 11111111
11111111 11111111 11111111 11111111 00000001
```
这是2的二进制补码，在无符号算术中定义为~0 - 2 + 1，其中~0是全 1 64 位整数。了解为什么会产生如此多的结果是一个有用的练习。

intN使用“ZigZag”编码而不是二进制补码来编码负整数。正整数p被编码为2 * p（偶数），而负整数n被编码为2 * |n| - 1（奇数）。因此，编码在正数和负数之间“之字形”。例如：

|源码|编码|
|         |
|0|0|
|-1|1|
|1|2|
|-2|3|
|...|...|
|0x7fffffff 0x7fffffff|0xfffffffe|
|0x80000000 |0xffffffff 0xffffffff|

换句话说，每个N都是用以下编码
```
(N<<1)^(N>>31);
```

对于64位，则有：
```
(N << 1) ^ (N>>63)
```

## 非变体数字
非 varint 数字类型很简单,诸如double,float, fixed32,fixed64类型数据都是按照固定字节数存储的

## 带有长度前缀的数据
长度前缀是类型的另一个主要概念。同时，长度也采用变长编码，后面为负载数值。

考虑这个消息模式：
```
message Test2 {
  optional string b = 2;
}
```
该字段的记录b是一个字符串，并且字符串是LEN经过编码的。如果我们设置 b为"testing"，我们将编码为LEN字段号为 2 且包含 ASCII 字符串的记录"testing"。结果是`120774657374696e67`。分解字节，
```
07 [74 65 73 74 69 6e 67]
```
我们看到长度前缀是 int32 varint 7，接下来的七个字节是 的 UTF-8 编码"testing"。int32 varint 表示字符串的最大长度为 2GB。

bytes字段以相同的方式编码。

## repeated
可以重复添加数据的类型，属于`length-body`编码类型，首先编码数据数量(采用varint编码模式)，然后按照数据的顺序进行编码。